# Configuración VPN Site to site Juniper
Trabajando con las interfaces creadas por defecto.

## Paso 1: Configuración de los security services
> [!NOTE]
> Por defecto, la zona pública tiene habilitados todos los servicios (ssh, ping, dhcp, telnet, etc). Para mayor seguridad, se recomienda deshabilitar todo los servicios públicos y habilitar solo los necesarios para la VPN (ssh, ping e IKE). Validar el impacto de esta configuración sobre el appliance para no interferir con servicios en uso.

## Recomendación: Habilitar solo los servicios ping e IKE en la interfaz pública
### Editar la security zone SL-PUBLIC
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security zones security-zone SL-PUBLIC 
[edit security zones security-zone SL-PUBLIC]
```
### Asignar los servicios de ssh, ping e IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ssh     
[edit security zones security-zone SL-PUBLIC]
```
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ping    
[edit security zones security-zone SL-PUBLIC]
```
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ike     
[edit security zones security-zone SL-PUBLIC]
```
### Guardar los cambios
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
```
### Eliminar la instrucción any de los servicios en la interfaz ae1.0
```go
root@gatewaydallas10pod1-vsrx-vSRX# delete security zones security-zone SL-PUBLIC interfaces ae1.0 host-inbound-traffic system-services all                                     
[edit]
```
### Verificar los servicios en las interfaces
```go
root@gatewaydallas10pod1-vsrx-vSRX# show security zones                                                                                    
security-zone SL-PRIVATE {
    interfaces {
        ae0.0 {
            host-inbound-traffic {
                system-services {
                    all;
                }
            }
        }
    }
}
security-zone SL-PUBLIC {
    interfaces {
        ae1.0 {
            host-inbound-traffic {
                system-services {
                    ssh;
                    ping;
                    ike;
                }
            }
        }
    }
}
```
## Paso 2: Configuración de la fase 1 IKE
> [!NOTE]
> Se requiere que navegue varios niveles en la jerarquía de conexiones, tener cuidado y guardar los cambios (commit) para guardar las configuraciones antes de subir (exit).
### Ingresa a la configuración IKE
Entrar en la jerarquía de security IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security ike   
[edit security ike]
```
### Define la propuesta ike
Ingresar la propuesta IKE. La estructura del comando es la siguiente:
```go
set proposal <nombre_propuesta> 
<nombre_propuesta>: Un nombre descriptivo para la propuesta IKE.
```
En este ejemplo llamaremos a la propuesta "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set proposal standard 
[edit security ike]
```
### Editar la propuesta creada
Ingresar a la propuesta "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit proposal standard 
[edit security ike proposal standard]
```
### Definir el método de autenticación
Estructura del comando:
```go
set authentication-method <método_autenticación>
<método_autenticación>: Método de autenticación, como dsa-signatures, ecdsa-signatures-256, ecdsa-signatures-384, pre-shared-keys o rsa-signatures
```
En este ejemplo usaremos el método "pre-shared-keys"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set authentication-method pre-shared-keys   
[edit security ike proposal standard]
```
### Definir el Diffie Hellman Group
Estructura del comando: 
```go
set dh-group <grupo_DH>
<grupo_DH>: Grupo de Diffie-Hellman para el intercambio de claves como group1, group14, group19, group2, group20, group24 o group5
```
En este ejemplo usaremos el grupo DH "group14"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set dh-group group14 
[edit security ike proposal standard]
```
### Definir el algoritmo de encriptación 
Estructura del comando: 
```go
set encryption-algorithm <algoritmo_cifrado>
<algoritmo_cifrado>: Algoritmo de cifrado, como 3des-cbc, aes-128-cbc, aes-128-gcm, aes-192-cbc, aes-256-cbc, aes-256-gcm, des-cbc
```
En este ejemplo usaremos el algoritmo "aes-256-cbc"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set encryption-algorithm aes-256-cbc 
[edit security ike proposal standard]
```
### Definir el tiempo de vida en segundos 
Estructura del comando: 
```go
set lifetime-seconds <tiempo_vida_segundos>
<tiempo_vida_segundos>: Tiempo de vida de la negociación IKE en segundos (de 180 a 86400 segundos).
```
En este ejemplo usaremos 3600 segundos
```go
root@gatewaydallas10pod1-vsrx-vSRX# set lifetime-seconds 3600               
[edit security ike proposal standard]
```
Guardar las configuraciones de la propuesta IKE y salir para subir de jerarquía
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit   
commit complete
[edit security ike proposal standard]
root@gatewaydallas10pod1-vsrx-vSRX# exit 
[edit security ike]
```
### Crear la política IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security ike   
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# set policy <nombre_politica>
<nombre_politica>: Nombre por asignar a la política
```
En este ejemplo nombrar "IKE-POL"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set policy IKE-POL 
[edit security ike]
```
### Editar la política creada
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit policy IKE-POL   
[edit security ike policy IKE-POL]
```
### Definir el modo de operación
Estructura de comando:
```go
set mode <modo>
<modo>: Modo de operación de la VPN IPsec, como main o aggressive.
```
En este ejemplo usar "main"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set mode main 
[edit security ike policy IKE-POL]
```
### Referenciar la propuesta IKE aplicada a la política
```go
set proposals <nombre_propuesta>
<nombre_propuesta>: El nombre de la propuesta IKE que definiste anteriormente.
```
Siguiendo el ejemplo la propuesta IKE fue nombrada "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set proposals standard   
[edit security ike policy IKE-POL]
```
### Define el método de autenticación de la política
```go
set pre-shared-key ascii-text <clave_precompartida>
<clave_precompartida>: La clave precompartida para la autenticación del peer remoto.
```
En este ejemplo usar "$ABC123"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set pre-shared-key ascii-text $ABC123 
[edit security ike policy IKE-POL]
```
Guardar las configuraciones de la política IKE y salir para subir de jerarquía
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
[edit security ike policy IKE-POL]
root@gatewaydallas10pod1-vsrx-vSRX# exit 
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# exit  
[edit]
```
### Crear el IKE Gateway y define su interfaz externa
Estructura del comando:
```go
set security ike gateway <nombre_gateway> external-interface <interfaz_gw>
<nombre_gateway>: Nombre asignado para el gateway
<interfaz_gw>: Interfaz pública que se asignará al gateway
```
En este ejemplo nombrar al gateway "IKE-GW" y asignar la intefaz pública ae1.0
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ike gateway IKE-GW external-interface ae1.0                  
[edit]
```
### Referenciar la política IKE al IKE Gateway
Estructura del comando:
```go
set security ike gateway <nombre_gateway> ike-policy <nombre_politica>
<nombre_gateway>: Nombre asignado para el gateway
<nombre_politica>: Política IKE asignada anteriormente
```
En este ejemplo referenciar al nombre del gateway creado "IKE-GW" y la política IKE creada "IKE-POL"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ike gateway IKE-GW ike-policy IKE-POL   
[edit]
```
### Definir la IP del IKE Gateway
Estructura del comando: 
```go
set security ike gateway <nombre_gateway> set-address <ip_gateway>
<nombre_gateway>: Nombre asignado para el gateway
<ip_gateway>: IP pública del gateway del segundo punto en la VPN
```
En este ejemplo referenciar al nombre del gateway creado "IKE-GW" y la IP asignada sería la IP pública del gateway Juniper de Washington (169.61.125.242)
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ike gateway IKE-GW address 169.61.125.242 
[edit]
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
```
### Validar las configuraciones IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# show security ike 
proposal standard {
    authentication-method pre-shared-keys;
    dh-group group14;
    encryption-algorithm aes-256-cbc;
    lifetime-seconds 3600;
}
policy IKE-POL {
    mode main;
    proposals standard;
    pre-shared-key ascii-text "$9$/ttx9Ap0OIhcrvWaZDjq.O1I"; ## SECRET-DATA
}
gateway IKE-GW {
    ike-policy IKE-POL;
    address 169.61.125.242;
    external-interface ae1.0;
}
```
## Paso 3: Configuración de la fase 2 (IPsec)
### Crear la propuesta IPsec
Estructura del comando: 
```go
set security ipsec proposal <nombre_propuesta>
<nombre_propuesta>: Un nombre descriptivo para la propuesta IPsec.
```
En este ejemplo la propuesta IPsec se llamará "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec proposal standard  
[edit]
```
### Definir el protocolo de la propuesta
Estructura del comando: 
```go
set security ipsec proposal <nombre_propuesta> protocol <protocolo>
<protocolo>: Protocolo de seguridad, como Authentication header (ah) o Encapsulated Security Payload header (esp)
```
En este ejemplo usaremos esp
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec proposal standard protocol esp 
[edit]
```
### Definir el algoritmo de autenticación IPsec
Estructura del comando: 
```go
set security ipsec proposal <nombre_propuesta> authentication-algorithm <algoritmo_autenticación>
<algoritmo_autenticación>: Algoritmo de autenticación, como hmac-md5-96, hmac-sha-256-128 o hmac-sha1-96
```
En este ejemplo usaremos hmac-sha-256-128
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec proposal standard authentication-algorithm hmac-sha-256-128 
[edit]
```
### Definir el algoritmo de encriptación IPsec
Estructura del comando: 
```go
set security ipsec proposal <nombre_propuesta> encryption-algorithm <algoritmo_cifrado>
<algoritmo_cifrado>: Algoritmo de cifrado, como a3des-cbc, aes-128-cbc, aes-128-gcm, aes-192-cbc, aes-192-gcm, aes-256-cbc, aes-256-gcm o des-cbc
```
En este ejemplo usaremos aes-256-cbc
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec proposal standard encryption-algorithm aes-256-cbc 
[edit]
```
### Definir el tiempo de vida de la negociación IPSec
Estructura del comando: 
```go
set security ipsec proposal <nombre_propuesta> lifetime-seconds <tiempo_vida_segundos>
<tiempo_vida_segundos>: Tiempo de vida de la negociación IPsec en segundos (de 180 a 86400)
```
En este ejemplo usaremos 3600
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec proposal standard lifetime-seconds 3600 
[edit]
```
### Crear la política IPSec
Estructura del comando: 
```go
set security ipsec policy <nombre_politica>
<nombre_politica>: Un nombre descriptivo para la política IPsec.
```
En este ejemplo usaremos "IPSEC-POL"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec policy IPSEC-POL 
[edit]
```
### Definir el tamaño de clave DH para Perfect Forward Secrecy (PFS)
Esta configuración puedes definirla como recomendación si está configurada también del otro lado.
Estructura del comando: 
```go
set security ipsec policy <nombre_politica> perfect-forward-secrecy keys <tamaño_clave_DH>
<tamaño_clave_DH>: El tamaño de la clave Diffie-Hellman para Perfect Forward Secrecy (PFS), como como group1, group14, group19, group2, group20, group24 o group5.
```
En este ejemplo usaremos "group14"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec policy IPSEC-POL perfect-forward-secrecy keys group14 
[edit]
```
### Referenciar la política IKE a la propuesta
Estructura del comando: 
```go
set security ipsec policy <nombre_politica> proposals <nombre_propuesta>
<nombre_propuesta>: El nombre de la propuesta IPsec que definiste anteriormente.
```
En este ejemplo usamos anteriormente "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec policy IPSEC-POL proposals standard
[edit]
```
### Crear un tunel VPN y especificar el IKE Gateway a la política IPsec
Estructura del comando: 
```go
set vpn <nombre_tunel_vpn> ike gateway <nombre_gateway_IKE>
<nombre_tunel_vpn>: Asignar nombre al tunel VPN.
<nombre_gateway_IKE>: Ingresar el nombre del gateway IKE creado anteriormente
```
En este ejemplo usamos como nombre de tunel "VPN-to-Host2" 
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec vpn VPN-to-Host2 ike gateway IKE-GW
[edit]
```
### Asignar la política IPsec al tunel VPN
Estructura del comando: 
```go
set vpn <nombre_de_tunel> ike ipsec-policy <nombre_politica_ipsec>
<nombre_de_tunel>: Nombre creado del tunel anteriormente
<nombre_politica_ipsec>: Nombre de la política creada anteriormente
```
En este ejemplo usamos como nombre de tunel "VPN-to-Host2" y la política fue "IPSEC-POL"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec vpn VPN-to-Host2 ike ipsec-policy IPSEC-POL   
[edit]
```
### Crear la zona de seguridad VPN
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security zones security-zone VPN host-inbound-traffic system-services ping 
[edit]
```
### Habilitar la interfaz st0.0 y asignar IP
En este caso asignamos la IP 10.100.200.1/24
```go
 set interfaces st0 unit 0 family inet address 10.100.200.1/24
```
### Asignar la interfaz st0.0 a la zona de seguridad VPN
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security zones security-zone VPN interfaces st0.0 
[edit]
```
### Asignar la interfaz st0.0 al tunel VPN
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec vpn VPN-to-Host2 bind-interface st0.0      
[edit]
```
### Configurar el tunel VPN en establecimiento inmediato
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ipsec vpn VPN-to-Host2 establish-tunnels immediately 
[edit]
```
### Validar la configuración del tunel VPN
```go
root@gatewaydallas10pod1-vsrx-vSRX# show security ipsec                                                  
proposal standard {
    protocol esp;
    authentication-algorithm hmac-sha-256-128;
    encryption-algorithm aes-256-cbc;
    lifetime-seconds 3600;
}
policy IPSEC-POL {
    perfect-forward-secrecy {
        keys group14;
    }
    proposals standard;
}
vpn VPN-to-Host2 {
    bind-interface st0.0;
    ike {
        gateway IKE-GW;
        ipsec-policy IPSEC-POL;
    }
    establish-tunnels immediately;
}
```



------> Revisar las configuraciones de las security policies <--------------- pg 421

### Crea una política de seguridad para permitir el tráfico a través del túnel IPsec.

```go
set security policies from-zone <zona_origen> to-zone <zona_destino> policy <nombre_politica> match source-address <direccion_origen> destination-address <direccion_destino> application <aplicacion> then permit
set security policies from-zone <zona_origen> to-zone <zona_destino> policy <nombre_politica> then permit tunnel ipsec-vpn <nombre_tunel>
```

#### Explicación

```go
<zona_origen>: Zona de seguridad del tráfico de origen.
<zona_destino>: Zona de seguridad del tráfico de destino.
<nombre_politica>: Un nombre descriptivo para la política de seguridad.
<direccion_origen>: Dirección IP de origen.
<direccion_destino>: Dirección IP de destino.
<aplicacion>: La aplicación o el tipo de tráfico que deseas permitir.
<nombre_tunel>: El nombre del túnel IPsec.
```

## Paso 5: Confirmar y aplicar la configuración
### Verifica la configuración.

```go
show interfaces
show security ike security-associations
show security ipsec security-associations
```

### Guarda los cambios y activa la configuración.
```go
commit
```









------------------







## Paso 1: Configuración de los parámetros generales de la VPN
Accede al firewall Juniper utilizando SSH, Telnet o la interfaz de línea de comandos (CLI).
### Ingresa al modo de configuración.
```go
configure 
```
### Crea una interfaz para la VPN IPsec.
```go
set interfaces st0 unit 0 family inet
```
Explicación: Esto crea una interfaz de túnel (st0) para la VPN IPsec.