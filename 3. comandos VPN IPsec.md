# Configuración VPN Site to site Juniper
Trabajando con las interfaces creadas por defecto.

## Paso 1: Configuración de los security services
> [!NOTE]
> Por defecto, la zona pública tiene habilitados todos los servicios (ssh, ping, dhcp, telnet, etc). Para mayot seguridad, se recomienda deshabilitar todo los servicios públicos y habilitar solo los necesarios para la VPN (ssh, ping e IKE). Validar el impacto de esta configuración sobre el appliance para no interferir con servicios en uso.

## Recomendación: Habilitar solo los servicios ping e IKE en la interfaz pública
### Editar la security zone SL-PUBLIC
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security zones security-zone SL-PUBLIC 
[edit security zones security-zone SL-PUBLIC]
```
### Asignar los servicios de ssh, ping e IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ssh     
[edit security zones security-zone SL-PUBLIC]
```
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ping    
[edit security zones security-zone SL-PUBLIC]
```
```go
root@gatewaydallas10pod1-vsrx-vSRX# set interfaces ae1.0 host-inbound-traffic system-services ike     
[edit security zones security-zone SL-PUBLIC]
```
### Guardar los cambios
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
```
### Eliminar la instrucción any de los servicios en la interfaz ae1.0
```go
root@gatewaydallas10pod1-vsrx-vSRX# delete security zones security-zone SL-PUBLIC interfaces ae1.0 host-inbound-traffic system-services all                                     
[edit]
```
### Verificar los servicios en las interfaces
```go
root@gatewaydallas10pod1-vsrx-vSRX# show security zones                                                                                    
security-zone SL-PRIVATE {
    interfaces {
        ae0.0 {
            host-inbound-traffic {
                system-services {
                    all;
                }
            }
        }
    }
}
security-zone SL-PUBLIC {
    interfaces {
        ae1.0 {
            host-inbound-traffic {
                system-services {
                    ssh;
                    ping;
                    ike;
                }
            }
        }
    }
}
```
## Paso 2: Configuración de la fase 1 IKE
> [!NOTE]
> Se requiere que navegue varios niveles en la jerarquía de conexiones, tener cuidado y guardar los cambios (commit) para guardar las configuraciones antes de subir (exit).
### Ingresa a la configuración IKE
Entrar en la jerarquía de security IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security ike   
[edit security ike]
```
### Define la propuesta ike
Ingresar la propuesta IKE. La estructura del comando es la siguiente:
```go
set proposal <nombre_propuesta> 
<nombre_propuesta>: Un nombre descriptivo para la propuesta IKE.
```
En este ejemplo llamaremos a la propuesta "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set proposal standard 
[edit security ike]
```
### Editar la propuesta creada
Ingresar a la propuesta "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit proposal standard 
[edit security ike proposal standard]
```
### Definir el método de autenticación
Estructura del comando:
```go
set authentication-method <método_autenticación>
<método_autenticación>: Método de autenticación, como dsa-signatures, ecdsa-signatures-256, ecdsa-signatures-384, pre-shared-keys o rsa-signatures
```
En este ejemplo usaremos el método "pre-shared-keys"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set authentication-method pre-shared-keys   
[edit security ike proposal standard]
```
### Definir el Diffie Hellman Group
Estructura del comando: 
```go
set dh-group <grupo_DH>
<grupo_DH>: Grupo de Diffie-Hellman para el intercambio de claves como group1, group14, group19, group2, group20, group24 o group5
```
En este ejemplo usaremos el grupo DH "group14"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set dh-group group14 
[edit security ike proposal standard]
```
### Definir el algoritmo de encriptación 
Estructura del comando: 
```go
set encryption-algorithm <algoritmo_cifrado>
<algoritmo_cifrado>: Algoritmo de cifrado, como 3des-cbc, aes-128-cbc, aes-128-gcm, aes-192-cbc, aes-256-cbc, aes-256-gcm, des-cbc
```
En este ejemplo usaremos el algoritmo "aes-256-cbc"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set encryption-algorithm aes-256-cbc 
[edit security ike proposal standard]
```
### Definir el tiempo de vida en segundos 
Estructura del comando: 
```go
set lifetime-seconds <tiempo_vida_segundos>
<tiempo_vida_segundos>: Tiempo de vida de la negociación IKE en segundos (de 180 a 86400 segundos).
```
En este ejemplo usaremos 3600 segundos
```go
root@gatewaydallas10pod1-vsrx-vSRX# set lifetime-seconds 3600               
[edit security ike proposal standard]
```
Guardar las configuraciones de la propuesta IKE y salir para subir de jerarquía
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit   
commit complete
[edit security ike proposal standard]
root@gatewaydallas10pod1-vsrx-vSRX# exit 
[edit security ike]
```
### Crear la política IKE
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit security ike   
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# set policy <nombre_politica>
<nombre_politica>: Nombre por asignar a la política
```
En este ejemplo nombrar "IKE-POL"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set policy IKE-POL 
[edit security ike]
```
### Editar la política creada
```go
root@gatewaydallas10pod1-vsrx-vSRX# edit policy IKE-POL   
[edit security ike policy IKE-POL]
```
### Definir el modo de operación
Estructura de comando:
```go
set mode <modo>
<modo>: Modo de operación de la VPN IPsec, como main o aggressive.
```
En este ejemplo usar "main"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set mode main 
[edit security ike policy IKE-POL]
```
### Referenciar la propuesta IKE aplicada a la política
```go
set proposals <nombre_propuesta>
<nombre_propuesta>: El nombre de la propuesta IKE que definiste anteriormente.
```
Siguiendo el ejemplo la propuesta IKE fue nombrada "standard"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set proposals standard   
[edit security ike policy IKE-POL]
```
### Define el método de autenticación de la política
```go
set pre-shared-key ascii-text <clave_precompartida>
<clave_precompartida>: La clave precompartida para la autenticación del peer remoto.
```
En este ejemplo usar "$ABC123"
```go
root@gatewaydallas10pod1-vsrx-vSRX# set pre-shared-key ascii-text $ABC123 
[edit security ike policy IKE-POL]
```
Guardar las configuraciones de la política IKE y salir para subir de jerarquía
```go
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
[edit security ike policy IKE-POL]
root@gatewaydallas10pod1-vsrx-vSRX# exit 
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# commit 
commit complete
[edit security ike]
root@gatewaydallas10pod1-vsrx-vSRX# exit  
[edit]
```
### Crear el IKE Gateway y define su interfaz externa
Estructura del comando:

```go
set security ike gateway <nombre_gateway> external-interface <interfaz_gw>
<nombre_gateway>: Nombre asignado para el gateway
<interfaz_gw>: Interfaz pública que se asignará al gateway
```
En este ejemplo nombrar al gateway "IKE-GW" y asignar la intefaz pública ae1.0
```go
root@gatewaydallas10pod1-vsrx-vSRX# set security ike gateway IKE-GW external-interface ae1.0                  
[edit]
```



## Paso 3: Configuración de la fase 2 (IPsec)
### Configura la fase 2 del túnel IPsec.

```go
set security ipsec proposal <nombre_propuesta> protocol <protocolo>
set security ipsec proposal <nombre_propuesta> authentication-algorithm <algoritmo_autenticación>
set security ipsec proposal <nombre_propuesta> encryption-algorithm <algoritmo_cifrado>
set security ipsec proposal <nombre_propuesta> lifetime-seconds <tiempo_vida_segundos>
```
#### Explicación

```go
<nombre_propuesta>: Un nombre descriptivo para la propuesta IPsec.
<protocolo>: Protocolo de seguridad, como esp.
<algoritmo_autenticación>: Algoritmo de autenticación, como hmac-sha1-96.
<algoritmo_cifrado>: Algoritmo de cifrado, como aes256-cbc.
<tiempo_vida_segundos>: Tiempo de vida de la negociación IPsec en segundos.
```

#### Ejemplo

```go
set security ipsec proposal proposal2 protocol esp
set security ipsec proposal proposal2 authentication-algorithm hmac-sha1-96
set security ipsec proposal proposal2 encryption-algorithm aes-256-cbc
set security ipsec proposal proposal2 lifetime-seconds 3600
```

### Configura la política IPsec.

```go
set security ipsec policy <nombre_politica> perfect-forward-secrecy keys <tamaño_clave_DH>
set security ipsec policy <nombre_politica> proposals <nombre_propuesta>
```

#### Explicación

```go
<nombre_politica>: Un nombre descriptivo para la política IPsec.
<tamaño_clave_DH>: El tamaño de la clave Diffie-Hellman para Perfect Forward Secrecy (PFS).
<nombre_propuesta>: El nombre de la propuesta IPsec que definiste anteriormente.
```

## Paso 4: Configuración de las interfaces y la política de seguridad
### Asigna la interfaz de salida para el túnel IPsec.

```go
set security zones security-zone <zona_segura> interfaces st0.0
```

#### Explicación

```go
<zona_segura>: La zona de seguridad a la que pertenece la interfaz.
```

#### Ejemplo

```go
set security zones security-zone trust interfaces st0.0
```

### Crea una política de seguridad para permitir el tráfico a través del túnel IPsec.

```go
set security policies from-zone <zona_origen> to-zone <zona_destino> policy <nombre_politica> match source-address <direccion_origen> destination-address <direccion_destino> application <aplicacion> then permit
set security policies from-zone <zona_origen> to-zone <zona_destino> policy <nombre_politica> then permit tunnel ipsec-vpn <nombre_tunel>
```

#### Explicación

```go
<zona_origen>: Zona de seguridad del tráfico de origen.
<zona_destino>: Zona de seguridad del tráfico de destino.
<nombre_politica>: Un nombre descriptivo para la política de seguridad.
<direccion_origen>: Dirección IP de origen.
<direccion_destino>: Dirección IP de destino.
<aplicacion>: La aplicación o el tipo de tráfico que deseas permitir.
<nombre_tunel>: El nombre del túnel IPsec.
```

## Paso 5: Confirmar y aplicar la configuración
### Verifica la configuración.

```go
show interfaces
show security ike security-associations
show security ipsec security-associations
```

### Guarda los cambios y activa la configuración.
```go
commit
```









------------------







## Paso 1: Configuración de los parámetros generales de la VPN
Accede al firewall Juniper utilizando SSH, Telnet o la interfaz de línea de comandos (CLI).
### Ingresa al modo de configuración.
```go
configure 
```
### Crea una interfaz para la VPN IPsec.
```go
set interfaces st0 unit 0 family inet
```
Explicación: Esto crea una interfaz de túnel (st0) para la VPN IPsec.